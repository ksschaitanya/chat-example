<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../../../favicon.ico">

    <title>QuikPic</title>
    <style>
        .hidden {
            visibility: collapse;
        }

        #imgpnl {
            margin: 0;
            height: 100%;
            overflow: hidden;
        }

        .imgclass {
            min-height: 100%;
            min-width: 100%;
            height: auto;
            width: auto;
            position: absolute;
            top: -100%;
            bottom: -100%;
            left: -100%;
            right: -100%;
            margin: auto;
        }

        .input-file-trigger {
            display: block;
            padding: 14px 45px;
            background: #39D2B4;
            color: #fff;
            font-size: 1em;
            transition: all .4s;
            cursor: pointer;
        }

        .input-file {
            position: absolute;
            top: 0;
            left: 0;
            width: 225px;
            opacity: 0;
            padding: 14px 0;
            cursor: pointer;
        }

        .input-file:hover+.input-file-trigger,
        .input-file:focus+.input-file-trigger,
        .input-file-trigger:hover,
        .input-file-trigger:focus {
            background: #34495E;
            color: #39D2B4;
        }

        .btn-mint {
            color: #fff;
            background-color: #39D2B4;
            border-color: #007bff;
        }
    </style>

    <!-- Bootstrap core CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="http://getbootstrap.com/docs/4.1/examples/album/album.css" rel="stylesheet">
</head>

<body>

    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>


    <div id="divNav" class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-white border-bottom box-shadow">
        <h5 class="my-0 mr-md-auto font-weight-normal">QuikPic</h5>
        <nav class="my-2 my-md-0 mr-md-3">
            <input class="mr-sm-2" placeholder="email" id="pemail" aria-label="Search" type="text">
            <input class="mr-sm-2" placeholder="password" id="ppassword" aria-label="Search" type="password">
            <a class="p-2 text-dark" id="result" href="#">u</a>
        </nav>
        <button type="button" class="btn btn-outline-primary" onclick="Login()">Login</button>
        <button type="button" class="btn btn-outline-primary" onclick="Logout()">Logout</button>
        <button type="button" class="btn btn-outline-primary" onclick="verifyJWT()">ClientX</button>
    </div>

    <input class="form-control" id="token" placeholder="token" type="text">

    <div class="container">

        <div id="AdminPanel" class="hidden">
            <div id="parent" class="row">
                <div class="col-md-4">
                    <div class="card mb-4 box-shadow">
                        <div class="card-header">
                            <h4 class="my-0 font-weight-normal">New Frame</h4>
                        </div>
                        <div class="card-body">
                            <div id="framecontrol">
                                <button id="newFrameButton" type="button" onclick="newFrame()" class="btn btn-lg btn-block btn-primary">Add</button>
                                <h1 id="newFrameCode"></h1>
                                <br>
                                <h4 id="newFrameCodeMessage"></h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="ngdivscope" ng-app="myApp" ng-controller="myCtrl">
                <!-- <button type="button" ng-click="hidePrefs()" class="btn btn-primary btn-lg btn-block">Set Scope</button> -->
                <div id="parent2" class="row">
                    <div class="col-md-4" ng-repeat="x in records">
                        <div class="card mb-4 box-shadow">
                            <div class="card-header">
                                <h4 class="my-0 font-weight-normal">{{x.Name}}</h4>
                            </div>
                            <img id="{{x.Name}}" class="card-img-top" alt="Thumbnail [100%x225]" style="height: 225px; width: 100%; display: block;"
                                ng-src="{{x.imgData}}" data-holder-rendered="true">
                            <div class="card-body">
                                <div id="framecontrol">
                                    <div class="btn-group" role="group" aria-label="Basic example">
                                        <!-- <input id="{{'imgID'+ x.Name}}" type="file" onchange="encodeImageFileAsURLNEW(this)" class="btn btn-primary" style="width: 27%;"/> -->
                                        <input class="input-file" id="{{'imgID'+ x.Name}}" type="file" onchange="encodeImageFileAsURLNEW(this)" accept="image/gif, image/jpeg, image/png">
                                        <label tabindex="0" for="{{'imgID'+ x.Name}}" class="input-file-trigger">Upload</label>
                                        <button type="button" id="{{'btnID'+ x.Name}}" onclick="RotateImage(this)" class="btn btn-mint">Rotate</button>
                                        <button type="button" id="{{'refreshID'+ x.Name}}" onclick="myFunction(this)" class="btn btn-mint">Reset</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="parent2NEW" class="row">
                    <div class="col-md-4" ng-repeat="x in recordsNEW">
                        <div class="card mb-4 box-shadow">
                            <div class="card-header">
                                <h4 class="my-0 font-weight-normal">{{x.frame_code}}</h4>
                            </div>
                            <img id="{{x.frame_code}}" class="card-img-top" alt="Thumbnail [100%x225]" style="height: 225px; width: 100%; display: block;"
                                ng-src="{{x.image_url}}" data-holder-rendered="true">
                            <div class="card-body">
                                <div id="framecontrol" style="text-align: center;">
                                    <div class="btn-group" role="group" aria-label="Basic example">
                                        <input class="input-file" id="{{'imgID'+ x.frame_code}}" type="file" onchange="encodeImageFileAsURLNEW(this)" accept="image/gif, image/jpeg, image/png">
                                        <input id="{{'imgID'+ x.frame_code + 'b'}}" type="button" value="Upload" class="btn btn-mint" onclick="openDialog(this)" />
                                        <button type="button" id="{{'btnID'+ x.frame_code}}" onclick="RotateImage(this)" class="btn btn-mint">Rotate</button>
                                        <button type="button" id="{{'refreshID'+ x.frame_code}}" onclick="myFunction(this)" class="btn btn-mint">Reset</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>


        <div id="imgpnl">
            <!-- <img id="img" class="hidden" style="width:100%" /> -->
        </div>

        <footer id="divFooter" class="pt-4 my-md-5 pt-md-5 border-top">
            <div class="row">
                <div class="col-12 col-md">
                    <img class="mb-2" src="https://getbootstrap.com/docs/4.1/assets/brand/bootstrap-solid.svg" alt="" width="24" height="24">
                    <small class="d-block mb-3 text-muted">&copy; 2017-2018</small>
                </div>
                <div class="col-6 col-md">
                    <h5>Features</h5>
                    <ul class="list-unstyled text-small">
                        <li>
                            <a class="text-muted" href="#">Cool stuff</a>
                        </li>

                    </ul>
                </div>
                <div class="col-6 col-md">
                    <h5>Resources</h5>
                    <ul class="list-unstyled text-small">
                        <li>
                            <a class="text-muted" href="#">Resource</a>
                        </li>

                    </ul>
                </div>
                <div class="col-6 col-md">
                    <h5>About</h5>
                    <ul class="list-unstyled text-small">
                        <li>
                            <a class="text-muted" href="#">Team</a>
                        </li>

                    </ul>
                </div>
            </div>
        </footer>

    </div>


    <!-- Bootstrap core JavaScript
        ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script> -->
    <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery-slim.min.js"><\/script>')</script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <script src="http://getbootstrap.com/docs/4.1/assets/js/vendor/holder.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
    <script src="exif.js"></script>

    <script>

        var app = angular.module("myApp", []);
        app.controller("myCtrl", function ($scope) {
            $scope.hidePrefs = function () {
                $scope.records = [
                    // {
                    //     "Name": "New Frame",
                    //     "imgData": "data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22348%22%20height%3D%22225%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20348%20225%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_16450dd1175%20text%20%7B%20fill%3A%23eceeef%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A17pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_16450dd1175%22%3E%3Crect%20width%3D%22348%22%20height%3D%22225%22%20fill%3D%22%2355595c%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%22116.45000076293945%22%20y%3D%22120.3%22%3EThumbnail%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E"
                    // }
                ]
            }
            $scope.hidePrefs();
        });

        var originalImage = document.getElementById("img");
        var encryptedText = "";
        var decryptedText = "";
        window.URL = window.URL || window.webkitURL;

        var apiURL = "http://greatleo.com/quikpic/";
        //var apiURL = "http://localhost:51719/";

        $(document).ready(function () {
            verifyJWT();
            GetFrames();
        });

        // Actual Login Function
        function Login() {
            $.ajax({
                type: 'POST',
                //url: "https://reqres.in/api/login",
                url: apiURL + 'token',
                //data: { "email": "peter@klaven", "password": "cityslicka" },
                data: { "grant_type": "password", "username": $('#pemail').val(), "password": $('#ppassword').val() },
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                dataType: 'json',
                success: function (response) {
                    //token for reqres
                    //alert(response.token);
                    //alert(response.access_token);
                    localStorage.setItem("token", response.access_token);
                    $('#AdminPanel').removeClass("hidden");
                    $('#ngdivscope').removeClass("hidden");
                    //$('#ClientPanel').addClass("hidden");
                    document.getElementById("result").innerHTML = localStorage.getItem("session");
                    GetFrames();
                }
            });
        }

        // GetFrames
        function GetFrames() {
            var token = localStorage.getItem("token");
            var headers = {};
            if (token) {
                headers.Authorization = 'Bearer ' + token;
            }
            $.ajax({
                type: 'GET',
                url: apiURL + 'api/Frame/GetFrames',
                headers: headers,
                dataType: 'json',
                success: function (response) {
                    if (localStorage.getItem("frames2") === null) {
                        localStorage.setItem("frames2", response);
                    }
                    else {
                        var retrievedData2 = localStorage.getItem("frames2");
                        localStorage.setItem("frames2", response);
                        console.log(retrievedData2);
                    }
                    LoadFrames();
                },
                error: function (response) {
                    alert(response.error_description);
                }
            });
        }

        function LoadFrames() {
            var $scope = getScope('myCtrl');

            // Get this through count
            var numItems = $('.card').length;
            var framecontrol = "#framecontrol";
            var newframecontrol = "framecontrol" + numItems;

            $('#parent').empty();
            $('#parent').addClass("hidden");
            $('#ngdivscope').removeClass("hidden");
            $('#parent2NEW > #newframediv').remove();
            $('#AdminPanel').removeClass("hidden");
            $('#ngdivscope').removeClass("hidden");

            var retrievedData = localStorage.getItem("frames2");
            var framesArry = JSON.parse(retrievedData);

            framesArry.forEach(function (d) {
                //alert(d['frame_code']);
                var diu = d['image_url'];
                //alert(diu);
                loadDoc(diu, myFunction1, d['frame_code']);
            });

            // if (localStorage.getItem("frames2") === null) {
            //     $scope.recordsNEW = [
            //         {
            //             "frame_code": 'NEW CODE',
            //             "image_url": "data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22348%22%20height%3D%22225%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20348%20225%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_16450dd1175%20text%20%7B%20fill%3A%23eceeef%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A17pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_16450dd1175%22%3E%3Crect%20width%3D%22348%22%20height%3D%22225%22%20fill%3D%22%2355595c%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%22116.45000076293945%22%20y%3D%22120.3%22%3EThumbnail%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E"
            //         }
            //     ];
            //     localStorage.setItem("frames2", JSON.stringify($scope.records));
            // }
            // else {
            //     //$('#parent2').empty();
            //     var retrievedData = localStorage.getItem("frames2");
            //     var framesArry = JSON.parse(retrievedData);
            //     localStorage.setItem("frames2", JSON.stringify(framesArry));
            //     $scope.recordsNEW = framesArry;
            // }

            var retrievedData = localStorage.getItem("frames2");
            var framesArry = JSON.parse(retrievedData);
            localStorage.setItem("frames2", JSON.stringify(framesArry));
            $scope.recordsNEW = framesArry;

            $scope.$apply();

            $('#parent2NEW').append('<div id="newframediv" class="col-md-4"><div class="card mb-4 box-shadow"><div class="card-header"><h4 class="my-0 font-weight-normal">New Frame</h4></div><div class="card-body"><div id="' + newframecontrol + '"><button id="newFrameButton" type="button" onclick="newFrame()" class="btn btn-lg btn-block btn-primary">Add</button><h1 id="newFrameCode"></h1><br><h4 id="newFrameCodeMessage"></h4></div></div></div></div>');


        }

        // Actual Logout Function
        function Logout() {
            localStorage.setItem("token", "");
            localStorage.removeItem("frames");
            localStorage.removeItem("frames2");
            //$('#ClientPanel').removeClass("hidden");
            $('#AdminPanel').addClass("hidden");
            document.getElementById("result").innerHTML = localStorage.getItem("session");
        }

        // Actual client Display
        function Client() {
            localStorage.setItem("session", "");
            localStorage.setItem("token", "");
            //$('#ClientPanel').removeClass("hidden");
            $('#AdminPanel').empty();
            //socketSendCommand("checksession");
        }

        // Helper for Ng Scope element
        function getScope(ctrlName) {
            var sel = 'div[ng-controller="' + ctrlName + '"]';
            return angular.element(sel).scope();
        }

        // Helper for Code Generator
        function RandomeFrameCode() {
            var text = "";
            // var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
            // for (var i = 0; i < 5; i++)
            //     text += possible.charAt(Math.floor(Math.random() * possible.length));
            var token = localStorage.getItem("token");
            var headers = {};
            if (token) {
                headers.Authorization = 'Bearer ' + token;
            }
            $.ajax({
                type: 'GET',
                url: apiURL + 'api/Frame/GetFrameCode',
                headers: headers
            }).done(function (data) {
                //alert(data);
                text = data;
                $('#newFrameCode').html(text);
                $('#newFrameCodeMessage').html('enter code on QuikPic frame');
                $('#newFrameButton').addClass('hidden');
                //return text;
                self.result(data);
            }).fail(showError);

            // return text;
        }

        // Button Click on the Add New Frame
        function newFrame() {
            console.log("API CALL TO GET New Frame Code RandomeFrameCode");
            RandomeFrameCode();
            //var code = RandomeFrameCode();
            // $('#newFrameCode').html(code);
            // $('#newFrameCodeMessage').html('enter code on QuikPic frame');
            // $('#newFrameButton').addClass('hidden');

            var socket = io();
            //socket.emit('newframecode', 'refresh');
            var strTest = 'http://s3.amazonaws.com/assets/images/layout/header1.jpg';
            socket.emit('encrypt', strTest);
            console.log(encryptedText);
            socket.emit('decrypt', encryptedText);
        }

        // Client Activated Code from anywhere
        function setNewFrame() {
            var c = $('#newQuikPiccode').val();
            console.log("API CALL TO Validate New Frame Code");
            //if (c === 'ABC123XYZ') 
            if (true) {
                console.log("New Frame Code Added Successfully");
                if (localStorage.getItem("clienttoken") === "") {
                    $('#AdminPanel').addClass("hidden");
                    //$('#ClientPanel').addClass("hidden");
                    alert("Frame Activated !!")
                }
                // Sending the confirmation to admin
                var socket = io();
                socket.emit('newframecode', c);
            }
        }

        // Socket IO calls
        $(function () {
            var socket = io();

            socket.on('encrypt', function (msg) {
                console.log(msg);
                encryptedText = msg;
            });

            socket.on('decrypt', function (msg) {
                console.log(msg);
                decryptedText = msg;
            });

            socket.on('chat message', function (msg) {
                if (msg === 'checksession') {
                    if (localStorage.getItem("session") === "user") {
                        $('#AdminPanel').removeClass("hidden");
                        //$('#ClientPanel').addClass("hidden");
                        document.getElementById("result").innerHTML = localStorage.getItem("session");
                    }
                    else {
                        //$('#ClientPanel').removeClass("hidden");
                        $('#AdminPanel').addClass("hidden");
                        document.getElementById("result").innerHTML = localStorage.getItem("session");
                    }
                }
            });

            socket.on('sendImage', function (msg) {
                console.log('RESULT 222', msg);
                $('#' + msg.imgid).removeClass("hidden");
                console.log('socket.on(sendImage, function (msg) ' + msg.orientation);
                resetOrientation(msg.imgsrc, msg.orientation, function (resetBase64Image) {
                    //originalImagethis.src = resetBase64Image;
                    document.getElementById(msg.imgid).setAttribute('src', resetBase64Image);
                });
                //document.getElementById(msg.imgid).setAttribute('src', msg.imgsrc);
            });

            socket.on('newframecode', function (msg) {
                //alert($("#newFrameCode").html() + '---' + msg);

                if (msg == $("#newFrameCode").html().replace(/\"/g, '')) {



                    // Get this through count
                    var numItems = $('.card').length;
                    var framecontrol = "#framecontrol";
                    var newframecontrol = "framecontrol" + numItems;

                    $('#parent').empty();
                    $('#parent').addClass("hidden");
                    $('#ngdivscope').removeClass("hidden");
                    $('#parent2 > #newframediv').remove();

                    var $scope = getScope('myCtrl');
                    GetFrames();

                    if (localStorage.getItem("frames") === null) {
                        $scope.records = [
                            {
                                "Name": msg,
                                "imgData": "data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22348%22%20height%3D%22225%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20348%20225%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_16450dd1175%20text%20%7B%20fill%3A%23eceeef%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A17pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_16450dd1175%22%3E%3Crect%20width%3D%22348%22%20height%3D%22225%22%20fill%3D%22%2355595c%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%22116.45000076293945%22%20y%3D%22120.3%22%3EThumbnail%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E"
                            }
                        ];
                        localStorage.setItem("frames", JSON.stringify($scope.records));
                    }
                    else {
                        //$('#parent2').empty();
                        var retrievedData = localStorage.getItem("frames");
                        var framesArry = JSON.parse(retrievedData);
                        framesArry.push({
                            Name: msg,
                            imgData: "data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22348%22%20height%3D%22225%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20348%20225%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_16450dd1175%20text%20%7B%20fill%3A%23eceeef%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A17pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_16450dd1175%22%3E%3Crect%20width%3D%22348%22%20height%3D%22225%22%20fill%3D%22%2355595c%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%22116.45000076293945%22%20y%3D%22120.3%22%3EThumbnail%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E"
                        });
                        localStorage.setItem("frames", JSON.stringify(framesArry));
                        $scope.records = framesArry;
                    }

                    $scope.$apply();

                    $('#parent2').append('<div id="newframediv" class="col-md-4"><div class="card mb-4 box-shadow"><div class="card-header"><h4 class="my-0 font-weight-normal">New Frame</h4></div><div class="card-body"><div id="' + newframecontrol + '"><button id="newFrameButton" type="button" onclick="newFrame()" class="btn btn-lg btn-block btn-primary">Add</button><h1 id="newFrameCode"></h1><br><h4 id="newFrameCodeMessage"></h4></div></div></div></div>');


                }

            });

        });

        function myFunction(element) {
            var frameID = element.id;
            frameID = frameID.replace("refreshID", "");
            var originalImagethis = document.getElementById(frameID);
            originalImagethis.src = "data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22348%22%20height%3D%22225%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20348%20225%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_16450dd1175%20text%20%7B%20fill%3A%23echhhf%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A17pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_16450dd1175%22%3E%3Crect%20width%3D%22348%22%20height%3D%22225%22%20fill%3D%22%23ffffff%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%22116.45000076293945%22%20y%3D%22120.3%22%3EPicture Cleared%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E";
            var socket = io();
            socket.emit('sendImage', { 'imgsrc': originalImagethis.src, 'imgid': frameID });
        }

        function socketSendCommand(command) {
            var socket = io();
            socket.emit('chat message', command);
        }

        function openDialog(element) {
            alert(element.id);
            //document.getElementById(element.id.replace('b', '')).click();
            encodeImageFileAsURLNEW(document.getElementById(element.id.replace('b', '')));
            // little change
        }

        // Upload Image function call
        function encodeImageFileAsURLNEW(element) {

            window.URL = window.URL || window.webkitURL;

            console.log('image ID as ', element.id);
            var socket = io();
            var file = element.files[0];
            var urlblob = window.URL.createObjectURL(file);
            //alert(urlblob);
            var reader = new FileReader();
            var frameID = element.id;
            frameID = frameID.replace("imgID", "");
            var dir;


            EXIF.getData(file, function () {
                dir = EXIF.getTag(this, "Orientation");
                if (dir === undefined) {
                    localStorage.setItem("dir", 1);
                    dir = 1;
                }
                else {
                    localStorage.setItem("dir", dir);
                }
            });

            var retrievedData = localStorage.getItem("frames2");
            var framesArry = JSON.parse(retrievedData);

            
            // framesArry.push({
            //     Name: frameID,
            //     imgData: reader.result
            // });
            reader.onloadend = function () {
                //localStorage.setItem("frames", JSON.stringify(framesArry));
                console.log(frameID + ' orientation ' + dir);
                alert(' orientation : ' + dir);
                socket.emit('sendImage', { 'imgsrc': reader.result, 'imgid': frameID, 'orientation': dir });
                socket.emit('rotateImage', { 'direction': dir, 'imgid': frameID });
            }
            socket.emit('rotateImage', { 'direction': dir, 'imgid': frameID });
            // socket.on('sendImage', function (msg) {
            //     console.log('RESULT', msg);
            //     $('#' + frameID).setAttribute('src', msg.imgsrc);
            // });
            reader.readAsDataURL(file);

            var token = localStorage.getItem("token");
            var headers = {};
            if (token) {
                headers.Authorization = 'Bearer ' + token;
            }
            $.ajax({
                type: 'POST',
                url: apiURL + "api/Frame",
                //data: { "email": "ksschaitanya@gmail.com", "password": "Test0011!" },
                data: {
                    "frame_id": 0,
                    "frame_code": frameID,
                    "frame_size": "s",
                    "display_name": "Kitchen",
                    "image_url": "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c9/Rainbow-diagram-ROYGBIV.svg/800px-Rainbow-diagram-ROYGBIV.svg.png",
                    "picture": "",
                    "dateupdated": "2018-08-28T17:32:50.940559-04:00",
                    "deleted": false
                },
                headers: headers,
                dataType: 'json',
                success: function (response) {
                    document.getElementById("result").innerHTML = response;
                }
            });
        }

        function resetOrientation(srcBase64, srcOrientation, callback) {
            var img = new Image();

            img.onload = function () {
                var width = img.width,
                    height = img.height,
                    canvas = document.createElement('canvas'),
                    ctx = canvas.getContext("2d");

                // set proper canvas dimensions before transform & export
                if (4 < srcOrientation && srcOrientation < 9) {
                    canvas.width = height;
                    canvas.height = width;
                } else {
                    canvas.width = width;
                    canvas.height = height;
                }

                // transform context before drawing image
                switch (srcOrientation) {
                    case 2: ctx.transform(-1, 0, 0, 1, width, 0); break;
                    case 3: ctx.transform(-1, 0, 0, -1, width, height); break;
                    case 4: ctx.transform(1, 0, 0, -1, 0, height); break;
                    case 5: ctx.transform(0, 1, 1, 0, 0, 0); break;
                    case 6: ctx.transform(0, 1, -1, 0, height, 0); break;
                    case 7: ctx.transform(0, -1, -1, 0, height, width); break;
                    case 8: ctx.transform(0, -1, 1, 0, 0, width); break;
                    default: break;
                }

                // draw image
                ctx.drawImage(img, 0, 0);

                // export base64
                callback(canvas.toDataURL());
            };

            img.src = srcBase64;
        }

        function RotateImageOriginal(element) {
            var socket = io();
            var direction = 2;
            var frameID = element.id;
            frameID = frameID.replace("btnID", "");
            var originalImagethis = document.getElementById(frameID);
            var lsframeID = localStorage.getItem("frameid");
            var dir = localStorage.getItem("dir");
            var increment = 1;

            if (lsframeID === null) {
                localStorage.setItem("frameid", frameID);
                localStorage.setItem("dir", dir);
            }
            else {
                if (lsframeID === frameID) {
                    if (dir == 8) {
                        dir = direction;
                    }
                    else {
                        dir = parseInt(dir) + 1;
                    }
                    localStorage.setItem("dir", dir);
                }
                else {
                    localStorage.setItem("frameid", frameID);
                    localStorage.setItem("dir", 2);
                }
            }
            resetOrientation(originalImagethis.src, dir, function (resetBase64Image) {
                socket.emit('sendImage', { 'imgsrc': resetBase64Image, 'imgid': frameID });
                originalImagethis.src = resetBase64Image;
            });
        }

        function RotateImage(element) {
            var socket = io();
            var direction = 2;
            var frameID = element.id;
            frameID = frameID.replace("btnID", "");
            var originalImagethis = document.getElementById(frameID);
            var lsframeID = localStorage.getItem("frameid");
            var dir = localStorage.getItem("dir");
            var increment = 1;

            if (lsframeID === null) {
                localStorage.setItem("frameid", frameID);
                localStorage.setItem("dir", dir);
            }
            else {
                if (lsframeID === frameID) {
                    if (dir == 8) {
                        dir = direction;
                    }
                    else {
                        dir = parseInt(dir) + 1;
                    }
                    localStorage.setItem("dir", dir);
                }
                else {
                    localStorage.setItem("frameid", frameID);
                    localStorage.setItem("dir", 2);
                }
            }
            socket.emit('rotateImage', { 'direction': dir, 'imgid': frameID });
        }

        function verifyJWT() {
            console.log("verifyJWT here");
            var xhttp = new XMLHttpRequest();
            data = { token: localStorage.getItem("token") }
            console.log(data);
            xhttp.onreadystatechange = function () {
                if (xhttp.readyState == 4 && xhttp.status == 200) {
                    var response = JSON.parse(xhttp.responseText);
                    console.log("all good");
                }
                if (xhttp.readyState == 4 && xhttp.status == 403) {
                    console.log("NOT good");
                    console.log(JSON.parse(xhttp.responseText).message);
                }
            };
            xhttp.open("POST", "http://quikpic.herokuapp.com/verifyJWT", true);
            xhttp.setRequestHeader("Content-type", 'application/json; charset=UTF-8');
            xhttp.send(JSON.stringify(data));
        }

        //loadDoc('https://upload.wikimedia.org/wikipedia/commons/thumb/c/c9/Rainbow-diagram-ROYGBIV.svg/800px-Rainbow-diagram-ROYGBIV.svg.png', myFunction1,'1df')
        // Convert ImageURL to blob
        function loadDoc(url, cFunction, imgID) {
            var xhttp;
            xhttp = new XMLHttpRequest();
            // Ask for the result as an ArrayBuffer.
            xhttp.responseType = "arraybuffer";
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var arrayBufferView = new Uint8Array(this.response);
                    var blob = new Blob([arrayBufferView], { type: "image/jpeg" });
                    var urlCreator = window.URL || window.webkitURL;
                    var imageUrl = urlCreator.createObjectURL(blob);
                    cFunction(imageUrl, imgID);
                }
            };
            xhttp.open("GET", url, true);
            xhttp.send();
        }

        function myFunction1(xhttp, imgID) {
            //alert(xhttp);
            // var img = document.querySelector("#"+imgID);
            // img.src = xhttp;
            // img.onload = function() {
            //     var urlCreator = window.URL || window.webkitURL;
            //     urlCreator.revokeObjectURL(this.src);
            // }

            var retrievedData = localStorage.getItem("frames2");
            var data = JSON.parse(retrievedData);

            for (var i = 0; i < data.length; i++) {
                if (data[i].frame_code === imgID) {
                    data[i].image_url = xhttp;
                    break;
                }
            }
            localStorage.setItem("frames2", JSON.stringify(data));
            // var $scope = getScope('myCtrl');
            // $scope.recordsNEW = data;
            // $scope.$apply();

        }

    </script>
</body>

</html>